<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Groups - Soul Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-purple-600 to-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-heart text-2xl"></i>
                    <h1 class="text-2xl font-bold">Soul Connect</h1>
                </div>
                <div class="flex space-x-6">
                    <a href="index.html" class="hover:text-purple-200 font-semibold">Home</a>
                    <a href="chat.html" class="hover:text-purple-200 font-semibold">Chat</a>
                    <a href="support-groups.html" class="bg-white text-purple-600 px-4 py-2 rounded-lg font-semibold">Groups</a>
                    <a href="exercises.html" class="hover:text-purple-200 font-semibold">Exercises</a>
                </div>
                <div class="flex items-center space-x-3">
                    <span id="displayUsername"></span>
                    <button onclick="logout()" class="bg-white text-purple-600 px-4 py-2 rounded-lg font-semibold hover:bg-purple-50 transition">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Support Groups Section -->
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">ðŸ‘¥ Virtual Support Groups</h1>
            <p class="text-xl text-gray-600 max-w-2xl mx-auto">
                Connect with others who understand. Share experiences, find support, and heal together in safe, anonymous groups.
            </p>
        </div>

        <!-- Groups Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12" id="groupsContainer">
            <!-- Groups will be loaded here -->
        </div>

        <!-- Create Group Section -->
        <div class="bg-white rounded-2xl shadow-lg p-8 max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Create New Support Group</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Group Name</label>
                    <input type="text" id="groupName" placeholder="e.g., Anxiety Support Circle" 
                           class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Topic</label>
                    <select id="groupTopic" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="anxiety">Anxiety</option>
                        <option value="depression">Depression</option>
                        <option value="stress">Stress Management</option>
                        <option value="loneliness">Loneliness</option>
                        <option value="relationships">Relationships</option>
                        <option value="general">General Support</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                    <textarea id="groupDescription" placeholder="Describe what this group is about..." 
                              class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500 h-24"></textarea>
                </div>
                <button onclick="createSupportGroup()" class="w-full bg-purple-600 text-white py-4 rounded-xl font-semibold text-lg hover:bg-purple-700 transition">
                    Create Support Group
                </button>
            </div>
        </div>
    </div>

    <!-- Group Chat Modal -->
    <div id="groupChatModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-4xl h-[80vh] flex flex-col">
            <!-- Header -->
            <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 rounded-t-2xl flex justify-between items-center">
                <div>
                    <h3 id="groupChatTitle" class="text-xl font-bold">Group Chat</h3>
                    <p id="groupMemberCount" class="text-purple-200">0 members</p>
                </div>
                <button onclick="closeGroupChat()" class="text-white hover:text-purple-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Messages -->
            <div id="groupMessages" class="flex-1 overflow-y-auto p-4 space-y-4">
                <!-- Messages will appear here -->
            </div>

            <!-- Message Input -->
            <div class="border-t border-gray-200 p-4">
                <div class="flex space-x-4">
                    <input type="text" id="groupMessageInput" placeholder="Type your message..." 
                           class="flex-1 border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button onclick="sendGroupMessage()" class="bg-purple-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-purple-700 transition">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = JSON.parse(localStorage.getItem('currentUser'));
        let currentGroup = null;
        let websocket = null;

        // Load available groups
        async function loadSupportGroups() {
            try {
                const response = await fetch('http://localhost:8080/support-groups');
                const data = await response.json();
                
                const container = document.getElementById('groupsContainer');
                container.innerHTML = '';
                
                data.groups.forEach(group => {
                    const groupCard = `
                        <div class="bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition cursor-pointer group" onclick="joinGroup('${group.id}')">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-xl font-bold text-gray-800 group-hover:text-purple-600 transition">${group.name}</h3>
                                <span class="bg-purple-100 text-purple-600 px-3 py-1 rounded-full text-sm font-semibold">
                                    ${group.current_members}/${group.max_members}
                                </span>
                            </div>
                            <p class="text-gray-600 mb-4">${group.description}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-500">Topic: ${group.topic}</span>
                                <button class="bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-700 transition">
                                    Join Group
                                </button>
                            </div>
                        </div>
                    `;
                    container.innerHTML += groupCard;
                });
                
            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }

        // Create new support group
        async function createSupportGroup() {
            const name = document.getElementById('groupName').value;
            const topic = document.getElementById('groupTopic').value;
            const description = document.getElementById('groupDescription').value;
            
            if (!name || !description) {
                alert('Please fill in all fields');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:8080/support-groups/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, topic, description })
                });
                
                const data = await response.json();
                
                if (data.group) {
                    alert('Support group created successfully!');
                    loadSupportGroups();
                    // Clear form
                    document.getElementById('groupName').value = '';
                    document.getElementById('groupDescription').value = '';
                }
            } catch (error) {
                console.error('Error creating group:', error);
                alert('Error creating group');
            }
        }

        // Join a support group
        async function joinGroup(groupId) {
            if (!currentUser) {
                alert('Please login first');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:8080/support-groups/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        group_id: groupId, 
                        user_id: currentUser.id 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentGroup = data.group;
                    openGroupChat(data.group, data.member);
                } else {
                    alert('Failed to join group: ' + data.message);
                }
            } catch (error) {
                console.error('Error joining group:', error);
                alert('Error joining group');
            }
        }

        // Open group chat
        function openGroupChat(group, member) {
            document.getElementById('groupChatTitle').textContent = group.name;
            document.getElementById('groupMemberCount').textContent = `${group.members.length} members online`;
            document.getElementById('groupChatModal').classList.remove('hidden');
            document.getElementById('groupChatModal').classList.add('flex');
            
            // Load messages
            loadGroupMessages(group.id);
            
            // Connect to WebSocket
            connectWebSocket(group.id, member.user_id);
        }

        // Close group chat
        function closeGroupChat() {
            document.getElementById('groupChatModal').classList.add('hidden');
            document.getElementById('groupChatModal').classList.remove('flex');
            
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            currentGroup = null;
        }

        // Connect to WebSocket for real-time chat
        function connectWebSocket(groupId, userId) {
            websocket = new WebSocket(`ws://localhost:8080/ws/groups/${groupId}/${userId}`);
            
            websocket.onopen = function() {
                console.log('WebSocket connected');
                // Send join message
                websocket.send(JSON.stringify({
                    type: 'join_group',
                    user_id: userId,
                    group_id: groupId
                }));
            };
            
            websocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            websocket.onclose = function() {
                console.log('WebSocket disconnected');
            };
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            const messagesContainer = document.getElementById('groupMessages');
            
            if (data.type === 'new_message') {
                const message = data.message;
                const messageElement = `
                    <div class="flex ${message.user_id === currentUser.id ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-xs lg:max-w-md ${message.user_id === currentUser.id ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-800'} rounded-2xl p-4">
                            <div class="font-semibold text-sm mb-1 ${message.user_id === currentUser.id ? 'text-purple-200' : 'text-gray-600'}">
                                ${message.anonymous_name}
                            </div>
                            <div>${message.message_text}</div>
                            <div class="text-xs mt-1 ${message.user_id === currentUser.id ? 'text-purple-200' : 'text-gray-500'}">
                                ${new Date(message.timestamp).toLocaleTimeString()}
                            </div>
                        </div>
                    </div>
                `;
                messagesContainer.innerHTML += messageElement;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            else if (data.type === 'user_joined') {
                const notification = `
                    <div class="text-center">
                        <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm">
                            User joined the group
                        </span>
                    </div>
                `;
                messagesContainer.innerHTML += notification;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            else if (data.type === 'user_left') {
                const notification = `
                    <div class="text-center">
                        <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm">
                            User left the group
                        </span>
                    </div>
                `;
                messagesContainer.innerHTML += notification;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        // Send group message
        function sendGroupMessage() {
            const messageInput = document.getElementById('groupMessageInput');
            const message = messageInput.value.trim();
            
            if (!message || !currentGroup || !websocket) return;
            
            // Send via WebSocket
            websocket.send(JSON.stringify({
                type: 'chat_message',
                text: message,
                user_id: currentUser.id,
                group_id: currentGroup.id
            }));
            
            // Also send via HTTP for persistence
            // fetch('http://localhost:8080/support-groups/send-message', {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify({
            //         group_id: currentGroup.id,
            //         user_id: currentUser.id,
            //         message_text: message
            //     })
            // }).catch(console.error);
            
            messageInput.value = '';
        }

        // Load group messages
        async function loadGroupMessages(groupId) {
            try {
                const response = await fetch(`http://localhost:8080/support-groups/${groupId}/messages`);
                const data = await response.json();
                
                const messagesContainer = document.getElementById('groupMessages');
                messagesContainer.innerHTML = '';
                
                data.messages.forEach(message => {
                    const messageElement = `
                        <div class="flex ${message.user_id === currentUser.id ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-xs lg:max-w-md ${message.user_id === currentUser.id ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-800'} rounded-2xl p-4">
                                <div class="font-semibold text-sm mb-1 ${message.user_id === currentUser.id ? 'text-purple-200' : 'text-gray-600'}">
                                    ${message.anonymous_name}
                                </div>
                                <div>${message.message_text}</div>
                                <div class="text-xs mt-1 ${message.user_id === currentUser.id ? 'text-purple-200' : 'text-gray-500'}">
                                    ${new Date(message.timestamp).toLocaleTimeString()}
                                </div>
                            </div>
                        </div>
                    `;
                    messagesContainer.innerHTML += messageElement;
                });
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Enter key support for message input
        document.getElementById('groupMessageInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendGroupMessage();
            }
        });

        // Logout function
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }
            
            document.getElementById('displayUsername').textContent = currentUser.username;
            loadSupportGroups();
        });
    </script>
</body>
</html>